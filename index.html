<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D3alWatch | Real-time Deal Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@0.407.0/dist/umd/lucide.min.js"></script>
    <!-- EmailJS Library -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .deal-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .deal-card:hover { transform: translateY(-4px); border-color: #3b82f6; }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .filter-btn.active { background-color: #2563eb; color: white; border-color: transparent; }
        .logo-glow { filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.5)); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        .loading-shimmer {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Header -->
    <nav class="border-b border-slate-800 bg-slate-900/50 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3 cursor-pointer group" onclick="window.location.reload()">
                <div class="relative w-10 h-10 flex items-center justify-center logo-glow group-hover:scale-105 transition-transform">
                    <svg viewBox="0 0 100 100" class="w-full h-full">
                        <defs>
                            <linearGradient id="logo-grad" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#2563eb;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <path d="M10 50 Q50 10 90 50 Q50 90 10 50" fill="none" stroke="url(#logo-grad)" stroke-width="6" stroke-linecap="round" />
                        <path d="M25 50 Q50 25 75 50 Q50 75 25 50" fill="none" stroke="#60a5fa" stroke-width="4" />
                        <circle cx="50" cy="50" r="8" fill="white" class="pulse" />
                        <circle cx="53" cy="47" r="3" fill="white" fill-opacity="0.6" />
                    </svg>
                </div>
                <h1 class="text-xl font-bold tracking-tight">D3al<span class="text-blue-500">Watch</span></h1>
            </div>
            <div class="flex items-center gap-4">
                <div id="status-badge" class="hidden sm:flex items-center gap-2 text-xs font-medium px-3 py-1 rounded-full bg-emerald-500/10 text-emerald-400 border border-emerald-500/20">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 pulse"></span>
                    LIVE MONITORING
                </div>
                <button onclick="toggleAlertModal()" class="flex items-center gap-2 text-sm font-semibold bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-xl transition-all shadow-lg shadow-blue-900/20">
                    <i data-lucide="mail" size="16"></i>
                    <span>Set Alerts</span>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 mt-8 flex-grow w-full">
        <!-- AI Insight Section -->
        <section class="mb-10 p-6 rounded-2xl bg-gradient-to-br from-slate-900 to-slate-800 border border-slate-700 shadow-xl border-l-4 border-l-blue-500">
            <div class="flex items-center gap-3 mb-4">
                <div class="p-2 bg-blue-500/20 rounded-lg text-blue-400">
                    <i data-lucide="sparkles" size="24"></i>
                </div>
                <div>
                    <h2 class="text-lg font-semibold">D3alWatch AI Analyst</h2>
                    <p class="text-sm text-slate-400">Smart price analysis powered by Gemini</p>
                </div>
            </div>
            <div id="ai-content" class="text-slate-200 italic leading-relaxed min-h-[3rem]">
                Analyzing recent price changes...
            </div>
            <button id="refresh-ai-btn" onclick="getAIInsight()" class="mt-4 text-xs font-semibold uppercase tracking-wider text-blue-400 hover:text-blue-300 transition-colors flex items-center gap-2">
                <span>Refresh Analysis</span>
                <i data-lucide="refresh-cw" size="12" id="refresh-icon"></i>
            </button>
        </section>

        <!-- Filters -->
        <div id="filter-container" class="flex flex-wrap gap-3 mb-8">
            <button onclick="filterDeals('All')" class="filter-btn active px-4 py-2 rounded-xl bg-slate-800 text-slate-400 font-medium text-sm hover:bg-slate-700 transition-colors border border-slate-700">All Deals</button>
            <button onclick="filterDeals('Bambu Lab')" class="filter-btn px-4 py-2 rounded-xl bg-slate-800 text-slate-400 font-medium text-sm hover:bg-slate-700 transition-colors border border-slate-700">Bambu Lab</button>
            <button onclick="filterDeals('AzureFilm')" class="filter-btn px-4 py-2 rounded-xl bg-slate-800 text-slate-400 font-medium text-sm hover:bg-slate-700 transition-colors border border-slate-700">AzureFilm</button>
            <button onclick="filterDeals('Amazon')" class="filter-btn px-4 py-2 rounded-xl bg-slate-800 text-slate-400 font-medium text-sm hover:bg-slate-700 transition-colors border border-slate-700">Amazon</button>
        </div>

        <!-- Deal Grid -->
        <div id="deals-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-20">
            <div class="h-64 rounded-2xl loading-shimmer"></div>
            <div class="h-64 rounded-2xl loading-shimmer"></div>
            <div class="h-64 rounded-2xl loading-shimmer"></div>
        </div>
    </main>

    <!-- Footer Menu -->
    <footer class="mt-auto border-t border-slate-800 bg-slate-900/30 py-8">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="flex items-center gap-2 opacity-50">
                    <svg viewBox="0 0 100 100" class="w-5 h-5">
                        <path d="M10 50 Q50 10 90 50 Q50 90 10 50" fill="none" stroke="currentColor" stroke-width="8" />
                        <circle cx="50" cy="50" r="12" fill="currentColor" />
                    </svg>
                    <span class="text-sm font-semibold tracking-tight">D3alWatch</span>
                </div>
                <div class="flex flex-wrap justify-center gap-8 text-sm text-slate-400">
                    <button onclick="showInfo('contact')" class="hover:text-blue-400 transition-colors flex items-center gap-2">
                        <i data-lucide="phone" size="14"></i> Contact
                    </button>
                    <button onclick="showInfo('developers')" class="hover:text-blue-400 transition-colors flex items-center gap-2">
                        <i data-lucide="code-2" size="14"></i> Developers
                    </button>
                    <span class="flex items-center gap-2 cursor-default">
                        <i data-lucide="copyright" size="14"></i> 2026 D3alWatch
                    </span>
                </div>
                <div class="flex gap-4 opacity-50">
                    <i data-lucide="twitter" size="18" class="cursor-pointer hover:text-blue-400"></i>
                    <i data-lucide="github" size="18" class="cursor-pointer hover:text-blue-400"></i>
                </div>
            </div>
        </div>
    </footer>

    <!-- Email Alert Modal -->
    <div id="alert-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-950/80 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-300 px-4">
        <div class="bg-slate-900 border border-slate-700 p-8 rounded-3xl max-w-md w-full shadow-2xl">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h3 class="text-xl font-bold">D3alWatch Alerts</h3>
                    <p class="text-sm text-slate-400">Join the list. Get notified instantly.</p>
                </div>
                <button onclick="toggleAlertModal()" class="text-slate-500 hover:text-white transition-colors">
                    <i data-lucide="x"></i>
                </button>
            </div>
            
            <form id="alert-form" onsubmit="handleAlertSubmit(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 mb-2">Email Address</label>
                    <input type="email" id="subscriber-email" name="user_email" required placeholder="name@example.com" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition-colors">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 mb-2">Alert Threshold</label>
                    <select name="threshold" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition-colors">
                        <option value="any">Any Deal (Recommended)</option>
                        <option value="20">> 20% Discount</option>
                        <option value="40">> 40% Discount</option>
                    </select>
                </div>
                <button type="submit" id="submit-btn" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold transition-all transform active:scale-95 shadow-lg shadow-blue-900/30 mt-4 flex items-center justify-center gap-2">
                    <span id="btn-text">Enable Mail Alerts</span>
                    <i data-lucide="loader-2" class="animate-spin hidden" id="btn-loader"></i>
                </button>
                <p class="text-[10px] text-center text-slate-500">Service Provider: EmailJS</p>
            </form>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="info-modal" class="fixed inset-0 z-[110] flex items-center justify-center bg-slate-950/90 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-300 px-4">
        <div class="bg-slate-900 border border-slate-700 p-8 rounded-3xl max-w-sm w-full shadow-2xl relative">
            <button onclick="closeInfoModal()" class="absolute top-4 right-4 text-slate-500 hover:text-white transition-colors">
                <i data-lucide="x"></i>
            </button>
            <div id="info-modal-content"></div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-6 right-6 translate-y-32 opacity-0 transition-all duration-500 z-[101]">
        <div class="bg-blue-600 text-white p-4 rounded-2xl shadow-2xl flex items-center gap-4 max-w-sm">
            <div class="bg-white/20 p-2.5 rounded-full"><i data-lucide="mail-check" size="20"></i></div>
            <div>
                <p class="font-bold text-sm" id="toast-title">Success!</p>
                <p class="text-xs opacity-90" id="toast-body">Check your inbox.</p>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const apiKey = "AIzaSyC0Lrm2kGSnL3VwEZO5Pw0WJSxOPK4kuoE"; // Gemini API Key
        
        // EMAILJS KEYS (Replace with your actual keys from emailjs.com)
        const EMAILJS_PUBLIC_KEY = "YOUR_PUBLIC_KEY"; 
        const EMAILJS_SERVICE_ID = "YOUR_SERVICE_ID";
        const EMAILJS_TEMPLATE_ID = "YOUR_TEMPLATE_ID";

        // Initialize EmailJS
        (function() {
            if (typeof EMAILJS_PUBLIC_KEY !== 'undefined' && EMAILJS_PUBLIC_KEY !== "YOUR_PUBLIC_KEY") {
                emailjs.init(EMAILJS_PUBLIC_KEY);
            }
        })();

        let currentFilter = 'All';

        const mockDeals = [
            { id: 1, store: "Bambu Lab", product: "PLA Basic Refill", current: 16.99, old: 24.99, tag: "Best Seller", link: "https://store.bambulab.com" },
            { id: 2, store: "AzureFilm", product: "PETG Black 1kg", current: 14.50, old: 19.90, tag: "Flash Sale", link: "https://www.azurefilm.com" },
            { id: 3, store: "Bambu Lab", product: "PLA Matte (Buy 4+)", current: 15.99, old: 27.99, tag: "Bulk Discount", link: "https://store.bambulab.com" },
            { id: 4, store: "Prusa Research", product: "Prusament PLA Galaxy Black", current: 22.50, old: 29.00, tag: "Limited", link: "https://www.prusa3d.com" },
            { id: 5, store: "AzureFilm", product: "PLA Wood Filament", current: 18.00, old: 25.00, tag: "Promo Code: WOOD15", link: "https://www.azurefilm.com" },
            { id: 6, store: "Amazon", product: "eSUN PLA+ Grey 2-Pack", current: 32.99, old: 45.00, tag: "Coupon Clip", link: "https://amazon.com" }
        ];

        const initIcons = () => window.lucide && window.lucide.createIcons();

        async function speakWelcome(email) {
            const prompt = `Say cheerfully: Welcome to D3alWatch, ${email.split('@')[0]}! We've dispatched your welcome email.`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } }
                        }
                    })
                });
                const result = await response.json();
                const pcmData = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                if (pcmData) {
                    const audioBlob = pcmToWav(pcmData, 24000); 
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();
                }
            } catch (e) { console.error("TTS failed", e); }
        }

        function pcmToWav(base64Pcm, sampleRate) {
            const pcmBuffer = Uint8Array.from(atob(base64Pcm), c => c.charCodeAt(0)).buffer;
            const wavHeader = new ArrayBuffer(44);
            const view = new DataView(wavHeader);
            const writeString = (offset, string) => { for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); };
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + pcmBuffer.byteLength, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, pcmBuffer.byteLength, true);
            return new Blob([wavHeader, pcmBuffer], { type: 'audio/wav' });
        }

        async function handleAlertSubmit(e) {
            e.preventDefault();
            const email = document.getElementById('subscriber-email').value;
            const btnText = document.getElementById('btn-text');
            const btnLoader = document.getElementById('btn-loader');
            
            btnText.innerText = "Connecting to Mailer...";
            btnLoader.classList.remove('hidden');

            // 1. Voice Confirmation
            speakWelcome(email);

            // 2. Real Email Dispatch (if keys are set)
            if (EMAILJS_PUBLIC_KEY === "YOUR_PUBLIC_KEY") {
                // Fallback for demo purposes if keys aren't provided
                setTimeout(() => {
                    btnLoader.classList.add('hidden');
                    btnText.innerText = "Enable Mail Alerts";
                    toggleAlertModal();
                    showToast("Alert!", "Please set your EmailJS keys in the code to send real mail.");
                }, 1500);
                return;
            }

            try {
                await emailjs.sendForm(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, e.target);
                showToast("Real Mail Sent!", `Welcome email successfully sent to ${email}.`);
            } catch (error) {
                console.error('EmailJS Error:', error);
                showToast("Mailer Error", "Failed to send real email. Check console.");
            } finally {
                btnLoader.classList.add('hidden');
                btnText.innerText = "Enable Mail Alerts";
                toggleAlertModal();
            }
        }

        function showToast(title, body) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-title').innerText = title;
            document.getElementById('toast-body').innerText = body;
            toast.classList.remove('translate-y-32', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-32', 'opacity-0'), 6000);
        }

        async function getAIInsight() {
            const aiContent = document.getElementById('ai-content');
            const refreshIcon = document.getElementById('refresh-icon');
            aiContent.innerHTML = `<span class="animate-pulse">Analyzing...</span>`;
            if (refreshIcon) refreshIcon.classList.add('animate-spin');
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Summarize filament deals: ${JSON.stringify(mockDeals)}. 20 words max.` }] }] })
                });
                const result = await response.json();
                aiContent.innerHTML = result.candidates?.[0]?.content?.parts?.[0]?.text || "Ready.";
            } catch (e) { aiContent.innerHTML = "Offline."; }
            finally { if (refreshIcon) refreshIcon.classList.remove('animate-spin'); }
        }

        function filterDeals(store) {
            currentFilter = store;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.toggle('active', btn.innerText.includes(store)));
            renderDeals();
        }

        function renderDeals() {
            const grid = document.getElementById('deals-grid');
            const filtered = currentFilter === 'All' ? mockDeals : mockDeals.filter(d => d.store === currentFilter);
            grid.innerHTML = filtered.map(deal => `
                <div class="deal-card p-5 rounded-2xl bg-slate-900 border border-slate-800 flex flex-col justify-between shadow-lg">
                    <div>
                        <div class="flex justify-between items-start mb-4">
                            <span class="text-[10px] font-bold uppercase px-2 py-1 bg-slate-800 rounded text-slate-400 border border-slate-700">${deal.store}</span>
                            <span class="text-[10px] font-bold uppercase px-2 py-1 bg-blue-500/10 text-blue-400 rounded-full border border-blue-500/20">${deal.tag}</span>
                        </div>
                        <h3 class="font-semibold text-lg mb-1">${deal.product}</h3>
                        <div class="flex items-center gap-2">
                            <span class="text-2xl font-bold text-white">$${deal.current}</span>
                            <span class="text-sm text-slate-500 line-through">$${deal.old}</span>
                        </div>
                    </div>
                    <a href="${deal.link}" target="_blank" class="mt-6 w-full py-3 bg-slate-800 hover:bg-blue-600 text-center rounded-xl font-bold text-sm transition-all duration-300">View Deal</a>
                </div>
            `).join('');
            initIcons();
        }

        function toggleAlertModal() {
            const modal = document.getElementById('alert-modal');
            const isOpen = !modal.classList.contains('opacity-0');
            modal.classList.toggle('opacity-0', isOpen);
            modal.classList.toggle('pointer-events-none', isOpen);
            initIcons();
        }

        function showInfo(type) {
            const modal = document.getElementById('info-modal');
            const content = document.getElementById('info-modal-content');
            if (content) {
                if (type === 'contact') {
                    content.innerHTML = `
                        <div class="flex items-center gap-3 mb-4 text-blue-400">
                            <i data-lucide="mail"></i>
                            <h3 class="text-xl font-bold">Contact Support</h3>
                        </div>
                        <p class="text-sm text-slate-400 mb-2">For inquiries or site issues:</p>
                        <p class="text-lg font-mono text-white">u2026456039@gmail.com</p>
                    `;
                } else {
                    content.innerHTML = `
                        <div class="flex items-center gap-3 mb-4 text-blue-400">
                            <i data-lucide="code-2"></i>
                            <h3 class="text-xl font-bold">Engineering Team</h3>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <p class="text-xs font-bold uppercase text-slate-500 mb-1">Lead Developer</p>
                                <p class="text-lg text-white font-semibold">Marin Blinja</p>
                            </div>
                            <div>
                                <p class="text-xs font-bold uppercase text-slate-500 mb-1">Core Engine</p>
                                <p class="text-sm text-slate-300">Gemini 2.5 AI</p>
                            </div>
                        </div>
                    `;
                }
            }
            if (modal) {
                modal.classList.remove('opacity-0', 'pointer-events-none');
            }
            initIcons();
        }

        function closeInfoModal() { 
            const modal = document.getElementById('info-modal');
            if (modal) {
                modal.classList.add('opacity-0', 'pointer-events-none');
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            initIcons();
            renderDeals();
            getAIInsight();
        });
    </script>
</body>
</html>